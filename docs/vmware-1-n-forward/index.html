<!DOCTYPE html>
<html lang="en" dir="ltr"><head>
  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <meta name="description" content="LXD Compose">
  <meta name="author" content="Geaaru">
  <meta name="generator" content="Hugo 0.81.0" />
  
  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="icon" href="https://mottainaici.github.io/lxd-compose-docs/images/favicon.ico">

  <!-- Twitter Bootstrs CSS -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/bootstrap/bootstrap.min.css">
  <!-- Ionicons Fonts Css -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/ionicons/ionicons.min.css">
  <!-- animate css -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/animate-css/animate.css">
  <!-- Hero area slider css-->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/slider/slider.css">
  <!-- slick slider -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/slick/slick.css">
  <!-- Fancybox -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/facncybox/jquery.fancybox.css">
  <!-- hover -->
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/hover/hover-min.css">
  <!-- template main css file -->
  
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/css/style.min.css" media="screen">
  
	<!-- Custom stylesheet - for your changes -->
	
  <link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/css/custom.min.css" media="screen">
  
</head><head>
  <meta name="generator" content="Hugo 0.81.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="description" content="LXD Compose">
  <meta name="author" content="Geaaru">
  <meta name="generator" content="Hugo 0.81.0" />

<!-- Mobile Specific Metas -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<title></title>
<link rel="icon" href="https://mottainaici.github.io/lxd-compose-docs/images/favicon.ico">

<!-- Twitter Bootstrs CSS -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/bootstrap/bootstrap.min.css">
<!-- Ionicons Fonts Css -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/ionicons/ionicons.min.css">
<!-- animate css -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/animate-css/animate.css">
<!-- Hero area slider css-->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/slider/slider.css">
<!-- slick slider -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/slick/slick.css">
<!-- Fancybox -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/facncybox/jquery.fancybox.css">
<!-- hover -->
<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/plugins/hover/hover-min.css">
<!-- template main css file -->

<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/css/style.min.css" media="screen">

  
<!-- Custom stylesheet - for your changes -->

<link rel="stylesheet" href="https://mottainaici.github.io/lxd-compose-docs/css/custom.min.css" media="screen"><meta property="og:title" content="" />
<meta property="og:description" content="VmWare-LXD 1:N #  A different approach is to use a single VM where configure a single LXD instance to deploy multiple containers and supply different services.
In these use cases, the VM could expose the services:
  with a floating IP that is exposes over the VM network interface and the internal network is hidden. On this case it&rsquo;s used the Network Forward feature of LXD.
  through the PROXY protocol to reach an internal service without expose a direct access from external network and the internal service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mottainaici.github.io/lxd-compose-docs/docs/vmware-1-n-forward/" /><meta property="article:section" content="docs" />

<meta property="og:site_name" content="LXD Compose" />

<title>Vmware 1 N Forward | LXD Compose</title>
<link rel="manifest" href="/lxd-compose-docs/manifest.json">
<link rel="icon" href="/lxd-compose-docs/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/lxd-compose-docs/book.min.fced4329b6e116250f4be38d09e7215f9855a28c8e1914b3337a72505f196dc1.css" integrity="sha256-/O1DKbbhFiUPS&#43;ONCechX5hVooyOGRSzM3pyUF8ZbcE=">
<script defer src="/lxd-compose-docs/en.search.min.f6dbd32ba1c7ee6ada323ffee7e3eb33fad2b37ebf3e40c3d76ce0864bcdd092.js" integrity="sha256-9tvTK6HH7mraMj/&#43;5&#43;PrM/rSs36/PkDD12zghkvN0JI="></script>

<script defer src="/lxd-compose-docs/sw.min.0232c72a126fed7e0676141811678c3a5a10a4fd735ed4b603233bbcb7f842a7.js" integrity="sha256-AjLHKhJv7X4GdhQYEWeMOloQpP1zXtS2AyM7vLf4Qqc="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head><section class="top-bar animated-header">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<nav class="navbar navbar-expand-lg navbar-light bg-light">
					<a class="navbar-brand" href="https://mottainaici.github.io/lxd-compose-docs/">
						<img src="https://mottainaici.github.io/lxd-compose-docs/images/logo.png" alt="LXD Compose">
					</a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
						aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>

					<div class="collapse navbar-collapse" id="navigation">
						<ul class="navbar-nav ml-auto">
							
							<li class="nav-item">
								<a class="nav-link"
									href="https://mottainaici.github.io/lxd-compose-docs/">Home</a>
							</li>
							
							
							
							<li class="nav-item">
								<a class="nav-link"
									href="https://mottainaici.github.io/lxd-compose-docs/docs">Documentation</a>
							</li>
							
							
							
							<li class="nav-item">
								<a class="nav-link"
									href="https://github.com/MottainaiCI/lxd-compose/issues">Contact</a>
							</li>
							
							
						</ul>
					</div>
				</nav>
			</div>
		</div>
	</div>
</section><body dir="ltr">

  <div style="margin-top: 60px;">

  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>

<div class="book-search">
  <input type="text" id="book-search-input" placeholder="" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
  <a href="/lxd-compose-docs/docs/"><strong>The Project</strong></a></li>
<li>
  <a href="/lxd-compose-docs/docs/getting-started/"><strong>Getting Started</strong></a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/"><strong>Concepts</strong></a>
<ul>
<li>
  <a href="/lxd-compose-docs/docs/concepts/env/">Environments</a>
<ul>
<li>
  <a href="/lxd-compose-docs/docs/concepts/env/#profiles">Profiles</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/env/#networks">Networks</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/env/#commands">Commands</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/env/#storages">Storages</a></li>
</ul>
</li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/project/">Projects</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/group/">Groups</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/node/">Nodes</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/variable/">Variables</a></li>
<li>
  <a href="/lxd-compose-docs/docs/concepts/hook/">Hooks</a></li>
</ul>
</li>
<li>
  <a href="/lxd-compose-docs/docs/template_engine/"><strong>Template Engine</strong></a>
<ul>
<li>
  <a href="/lxd-compose-docs/docs/template_engine/#jinja2-engine">Jinja2 Engine</a></li>
<li>
  <a href="/lxd-compose-docs/docs/template_engine/#mottainai-engine">Mottainai Engine</a></li>
</ul>
</li>
<li>
  <a href="/lxd-compose-docs/docs/render_engine/"><strong>Render Engine</strong></a></li>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/"><strong>Tutorial</strong></a>
<ul>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/#setup-lxd-environment">Step1: Install LXD</a></li>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/#step-2-configure-lxd-client">Step2: Configure LXD Client</a></li>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/#step-3-configure-lxd-compose-configuration-file">Step3: Configure LXD Compose configuration file</a></li>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/#step-4-configure-lxd-profiles-and-networks">Step4: Configure LXD profiles and networks</a></li>
<li>
  <a href="/lxd-compose-docs/docs/tutorial/#step-5-create-your-first-project">Step5: Create your first project</a>
<br /></li>
</ul>
</li>
<li>
  <a href="/lxd-compose-docs/docs/vmware/"><strong>LXD Compose &amp; VMWare</strong></a>
<ul>
<li>
  <a href="/lxd-compose-docs/docs/vmware-1-1/">VmWare-LXD 1:1</a></li>
<li>
  <a href="/lxd-compose-docs/docs/vmware-1-n-forward/"class=active>VmWare-LXD 1:N</a></li>
</ul>
</li>
<li>
  <a href="/lxd-compose-docs/docs/galaxy/"><strong>LXD Compose Galaxy</strong></a></li>
<li>
  <a href="/lxd-compose-docs/docs/galaxy/"><strong>Deploy Services on Raspberry Pi</strong></a></li>
</ul>
<p><br /></p>






  
<ul>
  
  <li>
    <a href="https://github.com/MottainaiCI/lxd-compose" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://join.slack.com/t/mottainaici/shared_invite/zt-zdmrc651-IvxE9j~TT5ssv_CVo51uZg" target="_blank" rel="noopener">
        Official Slack Channel
      </a>
  </li>
  
  <li>
    <a href="https://github.com/sponsors/geaaru" target="_blank" rel="noopener">
        Support our work!
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page" >
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/lxd-compose-docs/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Vmware 1 N Forward</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown"><h1 id="vmware-lxd-1n">
  VmWare-LXD 1:N
  <a class="anchor" href="#vmware-lxd-1n">#</a>
</h1>
<p>A different approach is to use a single VM where configure
a single LXD instance to deploy multiple containers and supply
different services.</p>
<p>In these use cases, the VM could expose the services:</p>
<ul>
<li>
<p><code>with a floating IP</code> that is exposes over the VM network
interface and the internal network is hidden. On this case
it&rsquo;s used the Network Forward feature of LXD.</p>
</li>
<li>
<p><code>through the PROXY protocol</code> to reach an internal service
without expose a direct access from external network and
the internal service. In this case normally, it used
a reverse balancer like Nginx.</p>
</li>
<li>
<p><code>through a NAT proxy device</code> to reach an internal service
with a specific device proxy resource.</p>
</li>
<li>
<p><code>through a proxy device on loopback of the device</code>
with a specific device proxy resource.</p>
</li>
</ul>
<blockquote class="book-hint info">
  The official documentation about <em>devices proxy</em> is available
<a href="https://linuxcontainers.org/lxd/docs/latest/reference/devices_proxy/">here</a>.
</blockquote>

<h2 id="floating-ip-from-vm-iface">
  Floating IP from VM iface
  <a class="anchor" href="#floating-ip-from-vm-iface">#</a>
</h2>
<p>Between the features available in LXD and configurable through
<code>lxd-compose</code> exists the <em>Network Forwards</em> that permit to
define one or more Floating IP address configured in one or more
network interfaces of the node that will be used to define network
flows to redirect in the inside containers.</p>
<p>One of the way to understand how it works it through an example.</p>
<p>If we consider that the requirement is to expose two different TCP
services over two different ports with a single Floating IP:</p>
<ul>
<li>
<p>port <em>8081</em> for the service of the application A</p>
</li>
<li>
<p>port <em>8080</em> for the service of the application B</p>
</li>
</ul>
<p>the graph hereinafter, describe the behavior:</p>
<p>
  <img src="../../images/lxdc_vmware_forward.png#vmware-medium" alt="LXD Compose Vmware Floating IP" /></p>
<p>The IP address <em>192.168.10.10</em> is our <em>floating IP</em> that is reachable
from the external network. In the example is used a Private Network IP but using a real Public IP is pretty the same.</p>
<p>In particular, the IP address <em>192.168.10.10</em> is assigned to the <strong>srv0</strong>
interface as primary ip address or as additional IP address.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">4: srv0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
    link/ether ee:ce:9f:0b:c8:7c brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.92/24 brd 192.168.0.255 scope global noprefixroute srv0
       valid_lft forever preferred_lft forever
</code></pre></div><p>or</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
4: srv0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
    link/ether ee:ce:9f:0b:c8:7c brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.1/24 brd 192.168.0.255 scope global noprefixroute srv0
       valid_lft forever preferred_lft forever
    inet 192.168.0.92/24 scope global secondary srv0
       valid_lft forever preferred_lft forever
</code></pre></div><p>The <em>floating IP</em> is not managed by LXD and must be configured
manually.</p>
<p>The internal network bridge is <strong>mottainai0</strong> and is managed by LXD.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lxc network show mottainai0
config:
  bridge.driver: native
  dns.domain: mottainai.local
  dns.mode: managed
  ipv4.address: 172.18.1.249/23
  ipv4.dhcp: <span style="color:#e6db74">&#34;true&#34;</span>
  ipv4.firewall: <span style="color:#e6db74">&#34;true&#34;</span>
  ipv4.nat: <span style="color:#e6db74">&#34;true&#34;</span>
  ipv6.dhcp: <span style="color:#e6db74">&#34;false&#34;</span>
  ipv6.nat: <span style="color:#e6db74">&#34;false&#34;</span>
description: Network mottainai0 created by lxd-compose
name: mottainai0
type: bridge
used_by:
- /1.0/instances/c1
- /1.0/instances/c2
- /1.0/profiles/net-mottainai0
managed: true
status: Created
locations:
- none
</code></pre></div><p>In the example it&rsquo;s used the native bridge but it works with OVS
bridge too.</p>
<p>The <em>Application A</em> is exposed in the internal container <em>C2</em> over
the port <em>8090</em> and with the IP 172.18.1.1.</p>
<p>The <em>Application B</em> is exposed in the internal container <em>C1</em> over
the port <em>8080</em> and with the IP 172.18.1.2.</p>
<blockquote class="book-hint info">
  To define Network Forward rules you need to know the IP addresses
of the target containers. So you could create the containers and
later create/update the forward or using static IP addresses in
the containers.
</blockquote>

<p><code>lxd-compose</code> simplify the management of the Network Forward
more bloated through the <code>lxc</code> command.</p>
<p>A network forward listen address must be assigned to an existing
network and for this reason that the <code>lxd-compose</code> manage these
resources as extension of the network object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># LXD Compose specs to define Network Forward over a network device.</span>
<span style="color:#f92672">networks</span>:
- <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;mottainai0&#34;</span>
  <span style="color:#f92672">type</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>
  <span style="color:#f92672">config</span>:
    <span style="color:#f92672">bridge.driver</span>: <span style="color:#ae81ff">native</span>
    <span style="color:#f92672">dns.domain</span>: <span style="color:#ae81ff">mottainai.local</span>
    <span style="color:#f92672">dns.mode</span>: <span style="color:#ae81ff">managed</span>
    <span style="color:#f92672">ipv4.address</span>: <span style="color:#ae81ff">172.18.1.249</span><span style="color:#ae81ff">/23</span>
    <span style="color:#f92672">ipv4.dhcp</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">ipv4.firewall</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">ipv4.nat</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">ipv6.nat</span>: <span style="color:#e6db74">&#34;false&#34;</span>
    <span style="color:#f92672">ipv6.dhcp</span>: <span style="color:#e6db74">&#34;false&#34;</span>
  <span style="color:#f92672">forwards</span>:
    - <span style="color:#f92672">listen_address</span>: <span style="color:#e6db74">&#34;192.168.10.10&#34;</span>
      <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">tcp</span>
          <span style="color:#75715e"># Define a port or a port-range or a list of port.</span>
          <span style="color:#f92672">listen_port</span>: <span style="color:#e6db74">&#34;8081&#34;</span>
          <span style="color:#f92672">target_address</span>: <span style="color:#e6db74">&#34;172.18.1.1&#34;</span>
          <span style="color:#f92672">target_port</span>: <span style="color:#e6db74">&#34;8090&#34;</span>

        - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">tcp</span>
          <span style="color:#f92672">listen_port</span>: <span style="color:#e6db74">&#34;8080&#34;</span>
          <span style="color:#f92672">target_address</span>: <span style="color:#e6db74">&#34;172.18.1.2&#34;</span>
</code></pre></div><p>So, after define the network specifications and the forwards rules
in the target <em>environment</em> just create them with <code>lxd-compose</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lxd-compose  network create myproject mottainai0 --with-forwards -u
Network mottainai0 updated.
Network forwards of the net mottainai0 updated.
</code></pre></div><p>With the same command it&rsquo;s possible update the existing rules.</p>
<p>Indeed, the commands of <code>lxc</code> tool to run to check the configuration are:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lxc network forward list mottainai0
+----------------+-------------------------------------------------------------+------------------------+-------+
| LISTEN ADDRESS |                        DESCRIPTION                          | DEFAULT TARGET ADDRESS | PORTS |
+----------------+-------------------------------------------------------------+------------------------+-------+
| 192.168.10.10  | Network forward <span style="color:#66d9ef">for</span> ip 192.168.10.10 created by lxd-compose |                        | <span style="color:#ae81ff">2</span>     |
+----------------+-------------------------------------------------------------+------------------------+-------+
</code></pre></div><p>And this to see the detail of a specific listen address:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lxc network forward show mottainai0 192.168.10.10
description: Network forward <span style="color:#66d9ef">for</span> ip 192.168.10.10 created by lxd-compose
config: <span style="color:#f92672">{}</span>
ports:
- description: <span style="color:#e6db74">&#34;&#34;</span>
  protocol: tcp
  listen_port: <span style="color:#e6db74">&#34;8081&#34;</span>
  target_port: <span style="color:#e6db74">&#34;8090&#34;</span>
  target_address: 172.18.1.1
- description: <span style="color:#e6db74">&#34;&#34;</span>
  protocol: tcp
  listen_port: <span style="color:#e6db74">&#34;8080&#34;</span>
  target_address: 172.18.1.2
listen_address: 192.168.10.10
location: none
</code></pre></div><p>Under the hood LXD uses <code>iptables</code> or <code>nftables</code> to define a DNAT rule that permit to maintain
the origin source IP address when the connection reachs the internal node and a MASQUERADE rule
for the revert flow.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
$ sudo iptables -t nat -L -n
Chain PREROUTING <span style="color:#f92672">(</span>policy ACCEPT<span style="color:#f92672">)</span>
target     prot opt source               destination         
DNAT       tcp  --  0.0.0.0/0            192.168.10.10         tcp dpt:8080 /* generated <span style="color:#66d9ef">for</span> LXD network-forward mottainai0 */ to:172.18.1.2:8080

</code></pre></div><p>The use of <code>target_port</code> attribute is needed only when the public
listening ports are different from the internal else you
can just define the <code>listen_port</code> attribute.</p>
<p>The official LXD documentation of the Network Forward feature
is available 
  <a href="https://linuxcontainers.org/lxd/docs/latest/howto/network_forwards/">here</a>.</p>
<h2 id="using-proxy-protocol-to-reach-an-internal-service">
  Using PROXY protocol to reach an internal service
  <a class="anchor" href="#using-proxy-protocol-to-reach-an-internal-service">#</a>
</h2>
<p>LXD permits to define <em>proxy devices</em> to allow forwarding network connections
between host and instance. This makes it possible to forward traffic hitting
one of the host’s addresses to an address inside the instance or to do the
reverse and have an address in the instance connect through the host.</p>
<p>Between the different types of connections (udp, tcp, unix) it&rsquo;s possible
forward the connection encapsuled over the PROXY protocol that transmit
the sender information.</p>
<p>Using PROXY protocol like this example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;mottainai-https&#34;</span>
<span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Profile for export HTTPS port to Host&#34;</span>
<span style="color:#f92672">devices</span>:
  <span style="color:#f92672">https</span>:
    <span style="color:#f92672">bind</span>: <span style="color:#ae81ff">host</span>
    <span style="color:#f92672">connect</span>: <span style="color:#ae81ff">tcp:0.0.0.0:443</span>
    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">tcp:0.0.0.0:443</span>
    <span style="color:#f92672">nat</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">proxy_protocol</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">proxy</span>
</code></pre></div><p>permits to avoid using a static IP address inside the container.</p>
<p>In this case, it&rsquo;s a LXD process that execute the binding of the port
and proxy the connection inside the container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># # From the VM / Host</span>
<span style="color:#75715e"># netstat -lpn | grep lxd | grep 443</span>
tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::443                  :::*                    LISTEN      1229/lxd
</code></pre></div><h2 id="using-nat-proxy-device-to-reach-an-internal-service">
  Using NAT proxy device to reach an internal service
  <a class="anchor" href="#using-nat-proxy-device-to-reach-an-internal-service">#</a>
</h2>
<p>Always through the use of <em>device proxy</em> when the <code>nat</code> option
is enable the traffic is forwarded usint NAT than being proxied
through a separate connection, in this case you need ensure that the target
instance has a static IP configured in LXD on its NIC device.</p>
<p>To have a static IP address you need to configure the NIC device
with a configuration for the node similar to this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">devices</span>:
  <span style="color:#f92672">eth0</span>:
    <span style="color:#f92672">ipv4.address</span>: <span style="color:#ae81ff">172.18.1.1</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eth0</span>
    <span style="color:#f92672">nictype</span>: <span style="color:#ae81ff">bridged</span>
    <span style="color:#f92672">parent</span>: <span style="color:#ae81ff">mottainai0</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">nic</span>
  <span style="color:#f92672">myservice</span>:
    <span style="color:#f92672">bind</span>: <span style="color:#ae81ff">host</span>
    <span style="color:#f92672">connect</span>: <span style="color:#ae81ff">tcp:172.18.1.1:11000</span>
    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">tcp:192.168.10.10:11000</span>
    <span style="color:#f92672">nat</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">proxy_protocol</span>: <span style="color:#e6db74">&#34;false&#34;</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">proxy</span>
</code></pre></div><p>Without configure a static IP address for the <em>eth0</em> device the bind with NAT fail.</p>
<p>In addition, when <code>nat</code> is true you can&rsquo;t use <code>listen</code> with <code>tcp:0.0.0.0</code> but you need
define the external IP address where LXD will configure the NAT rule.</p>
<p>I think that using this solution it makes sense when you have a very little installation,
else the Network Forward way is better.</p>
<p>Under the hood, using the <code>nat</code> generates the configuration of these iptables rules:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo iptables -t nat -L -n
Chain PREROUTING <span style="color:#f92672">(</span>policy ACCEPT<span style="color:#f92672">)</span>
target     prot opt source               destination         
DNAT       tcp  --  0.0.0.0/0            192.168.10.10         tcp dpt:11000 /* generated <span style="color:#66d9ef">for</span> LXD container c2 <span style="color:#f92672">(</span>myservice<span style="color:#f92672">)</span> */ to:172.18.1.1:11000

Chain OUTPUT <span style="color:#f92672">(</span>policy ACCEPT<span style="color:#f92672">)</span>
target     prot opt source               destination         
DNAT       tcp  --  0.0.0.0/0            192.168.10.10         tcp dpt:11000 /* generated <span style="color:#66d9ef">for</span> LXD container c2 <span style="color:#f92672">(</span>myservice<span style="color:#f92672">)</span> */ to:172.18.1.1:11000

Chain POSTROUTING <span style="color:#f92672">(</span>policy ACCEPT<span style="color:#f92672">)</span>
target     prot opt source               destination         
MASQUERADE  tcp  --  172.18.1.1          172.18.1.1        tcp dpt:11000 /* generated <span style="color:#66d9ef">for</span> LXD container c2 <span style="color:#f92672">(</span>myservice<span style="color:#f92672">)</span> */

</code></pre></div><h2 id="using-proxy-device-to-reach-an-internal-service-on-localhost">
  Using proxy device to reach an internal service on localhost
  <a class="anchor" href="#using-proxy-device-to-reach-an-internal-service-on-localhost">#</a>
</h2>
<p>If the requirements of the called service is not identify the calling it&rsquo;s possible define
a proxy device rule that map an external port to a specific container through his loopback
interface.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;myservice&#34;</span>
<span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Profile for export port 12000 to Host&#34;</span>
<span style="color:#f92672">devices</span>:
  <span style="color:#f92672">https</span>:
    <span style="color:#f92672">bind</span>: <span style="color:#ae81ff">host</span>
    <span style="color:#f92672">connect</span>: <span style="color:#ae81ff">tcp:127.0.0.1:12000</span>
    <span style="color:#f92672">listen</span>: <span style="color:#ae81ff">tcp:0.0.0.0:12000</span>
    <span style="color:#f92672">nat</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">proxy_protocol</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">proxy</span>
</code></pre></div><p>In this case an LXD process is configured in binding on the specified port and the traffic
is proxied inside the container in the selected port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># # From the VM / Host</span>
<span style="color:#75715e"># netstat -lpn | grep lxd | grep 12000</span>
tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::12000                  :::*                    LISTEN      1229/lxd
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





  <div>
    <a class="flex align-center" href="https://github.com/MottainaiCI/lxd-compose-docs/edit/master/site/content/docs/vmware-1-n-forward.md" target="_blank" rel="noopener">
      <img src="/lxd-compose-docs/svg/edit.svg" class="book-icon" alt="Edit" />
      <span></span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  

  </div><!-- Footer Section Start -->
<footer id="footer">
  <div class="container">
    <div class="row content-justify-between">
      <div class="col-md-8 col-12 text-center text-lg-left text-md-left">
        <p class="copyright">Copyright:
          <span>
            <script>
              document.write(new Date().getFullYear())
            </script>
          </span> Daniele Rondina All Rights Reserved
        </p>
      </div>
      <div class="col-md-4 col-12">
        <!-- Social Media -->
        <ul class="social text-center text-md-right text-lg-right">
          
          <li><a href="https://github.com/MottainaiCI/lxd-compose"><i class="ion-social-github"></i></a></li>
          
          <li><a href="https://it.linkedin.com/in/danielerondina"><i class="ion-social-linkedin"></i></a></li>
          
          <li><a href="https://join.slack.com/t/mottainaici/shared_invite/zt-zdmrc651-IvxE9j~TT5ssv_CVo51uZg"><i class="ion-android-chat"></i></a></li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>
<!-- footer section end -->

<!-- jquery -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/jQurey/jquery.min.js"></script>
<!-- slick slider -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/slick/slick.min.js"></script>
<!-- bootstrap js -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/bootstrap/bootstrap.min.js"></script>
<!-- wow js -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/wow-js/wow.min.js"></script>
<!-- slider js -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/slider/slider.js"></script>
<!-- Fancybox -->
<script src="https://mottainaici.github.io/lxd-compose-docs/plugins/facncybox/jquery.fancybox.js"></script>
<!-- template main js -->

<script src="https://mottainaici.github.io/lxd-compose-docs/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'Your ID', 'auto');
  ga('send', 'pageview');
</script>
</body>

</html>












